function t(t,n,h,o){return new(h=h||Promise)(function(s,e){function i(t){try{r(o.next(t))}catch(t){e(t)}}function a(t){try{r(o.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?s(t.value):((e=t.value)instanceof h?e:new h(function(t){t(e)})).then(i,a)}r((o=o.apply(t,n||[])).next())})}class e{constructor(){this.listeners={}}on(t,e,s){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null!=s&&s.once){const s=()=>{this.un(t,s),this.un(t,e)};return this.on(t,s),s}return()=>this.un(t,e)}un(t,e){null!=(t=this.listeners[t])&&t.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class s extends e{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t())}}function i(t,e){const s=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,a]of Object.entries(e))if("children"===t)for(const[t,r]of Object.entries(e))"string"==typeof r?s.appendChild(document.createTextNode(r)):s.appendChild(i(t,r));else"style"===t?Object.assign(s.style,a):"textContent"===t?s.textContent=a:s.setAttribute(t,a.toString());return s}function a(t,e,s){t=i(t,e||{});return null!=s&&s.appendChild(t),t}function r(t,e,s,i){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,s){case"bartlett":for(a=0;a<t;a++)this.windowValues[a]=2/(t-1)*((t-1)/2-Math.abs(a-(t-1)/2));break;case"bartlettHann":for(a=0;a<t;a++)this.windowValues[a]=.62-.48*Math.abs(a/(t-1)-.5)-.38*Math.cos(2*Math.PI*a/(t-1));break;case"blackman":for(i=i||.16,a=0;a<t;a++)this.windowValues[a]=(1-i)/2-.5*Math.cos(2*Math.PI*a/(t-1))+i/2*Math.cos(4*Math.PI*a/(t-1));break;case"cosine":for(a=0;a<t;a++)this.windowValues[a]=Math.cos(Math.PI*a/(t-1)-Math.PI/2);break;case"gauss":for(i=i||.25,a=0;a<t;a++)this.windowValues[a]=Math.pow(Math.E,-.5*Math.pow((a-(t-1)/2)/(i*(t-1)/2),2));break;case"hamming":for(a=0;a<t;a++)this.windowValues[a]=.54-.46*Math.cos(2*Math.PI*a/(t-1));break;case"hann":case void 0:for(a=0;a<t;a++)this.windowValues[a]=.5*(1-Math.cos(2*Math.PI*a/(t-1)));break;case"lanczoz":for(a=0;a<t;a++)this.windowValues[a]=Math.sin(Math.PI*(2*a/(t-1)-1))/(Math.PI*(2*a/(t-1)-1));break;case"rectangular":for(a=0;a<t;a++)this.windowValues[a]=1;break;case"triangular":for(a=0;a<t;a++)this.windowValues[a]=2/t*(t/2-Math.abs(a-(t-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var a,r=1,n=t>>1;r<t;){for(a=0;a<r;a++)this.reverseTable[a+r]=this.reverseTable[a]+n;r<<=1,n>>=1}for(a=0;a<t;a++)this.sinTable[a]=Math.sin(-Math.PI/a),this.cosTable[a]=Math.cos(-Math.PI/a);this.calculateSpectrum=function(t){var e,s=this.bufferSize,i=this.cosTable,a=this.sinTable,r=this.reverseTable,n=new Float32Array(s),h=new Float32Array(s),o=2/this.bufferSize,l=Math.sqrt,c=new Float32Array(s/2),f=Math.floor(Math.log(s)/Math.LN2);if(Math.pow(2,f)!==s)throw"Invalid buffer size, must be a power of 2.";if(s!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+s+" Buffer Size: "+t.length;for(var u,p,d,w,b=1,M=0;M<s;M++)n[M]=t[r[M]]*this.windowValues[r[M]],h[M]=0;for(;b<s;){for(var g=i[b],v=a[b],m=1,y=0,x=0;x<b;x++){for(M=x;M<s;)p=m*n[u=M+b]-y*h[u],d=m*h[u]+y*n[u],n[u]=n[M]-p,h[u]=h[M]-d,n[M]+=p,h[M]+=d,M+=b<<1;m=(w=m)*g-y*v,y=w*v+y*g}b<<=1}for(var M=0,q=s/2;M<q;M++)(e=o*l((e=n[M])*e+(e=h[M])*e))>this.peak&&(this.peakBand=M,this.peak=e),c[M]=e;return c}}class n extends s{static create(t){return new n(t||{})}constructor(e){if(super(e),this.frequenciesDataUrl=e.frequenciesDataUrl,this.container="string"==typeof e.container?document.querySelector(e.container):e.container,e.colorMap){if(e.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let t=0;t<e.colorMap.length;t++)if(4!==e.colorMap[t].length)throw new Error("ColorMap entries must contain 4 values");this.colorMap=e.colorMap}else{this.colorMap=[];for(let t=0;t<256;t++){var s=(255-t)/256;this.colorMap.push([s,s,s,1])}}this.fftSamples=e.fftSamples||512,this.height=e.height||this.fftSamples/2,this.noverlap=e.noverlap,this.windowFunc=e.windowFunc,this.alpha=e.alpha,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.createWrapper(),this.createCanvas()}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",()=>this.render()))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}loadFrequenciesData(s){return t(this,void 0,void 0,function*(){const t=yield fetch(s);if(!t.ok)throw new Error("Unable to fetch frequencies data");var e=yield t.json();this.drawSpectrogram(e)})}createWrapper(){this.wrapper=a("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=a("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvas=a("canvas",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper),this.spectrCc=this.canvas.getContext("2d")}render(){var t;this.frequenciesDataUrl?this.loadFrequenciesData(this.frequenciesDataUrl):(t=null==(t=this.wavesurfer)?void 0:t.getDecodedData())&&this.drawSpectrogram(this.getFrequencies(t))}drawSpectrogram(t){isNaN(t[0][0])||(t=[t]),this.wrapper.style.height=this.height*t.length+"px",this.width=this.wavesurfer.getWrapper().offsetWidth,this.canvas.width=this.width,this.canvas.height=this.height*t.length;const s=this.spectrCc,i=this.height,a=this.width,r=this.buffer.sampleRate/2,n=this.frequencyMin,h=this.frequencyMax;if(s){for(let e=0;e<t.length;e++){const o=this.resample(t[e]),l=new ImageData(a,i);for(let e=0;e<o.length;e++)for(let t=0;t<o[e].length;t++){const r=this.colorMap[o[e][t]],n=4*((i-t)*a+e);l.data[n]=255*r[0],l.data[1+n]=255*r[1],l.data[2+n]=255*r[2],l.data[3+n]=255*r[3]}createImageBitmap(l).then(t=>{s.drawImage(t,0,i*(1-h/r),a,i*(h-n)/r,0,i*e,a,i)})}this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",t.length),this.emit("ready")}}getFrequencies(i){var a,n;const h=this.fftSamples,o=(null!=(a=this.options.splitChannels)?a:null!=(n=this.wavesurfer)&&n.options.splitChannels)?i.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||i.sampleRate/2,i){const l=(this.buffer=i).sampleRate,c=[];let s=this.noverlap;if(!s){const a=i.length/this.canvas.width;s=Math.max(0,Math.round(h-a))}const f=new r(h,l,this.windowFunc,this.alpha);for(let e=0;e<o;e++){const n=i.getChannelData(e),o=[];let t=0;for(;t+h<n.length;){const i=n.slice(t,t+h),a=f.calculateSpectrum(i),l=new Uint8Array(h/2);for(let t=0;t<h/2;t++)l[t]=Math.max(-255,45*Math.log10(a[t]));o.push(l),t+=h-s}c.push(o)}return c}}freqType(t){return 1e3<=t?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return 1e3<=t?"KHz":"Hz"}loadLabels(s,i,a,r,n,h,o,t,l){s=s||"rgba(68,68,68,0)",i=i||"12px",a=a||"12px",r=r||"Helvetica",n=n||"#fff",h=h||"#fff",o=o||"center";const c=this.height||512,f=c/256*5,u=this.frequencyMin,p=(this.frequencyMax-u)/f,d=this.labelsEl.getContext("2d"),w=window.devicePixelRatio;if(this.labelsEl.height=this.height*l*w,this.labelsEl.width=55*w,d.scale(w,w),d)for(let e=0;e<l;e++){let t;for(d.fillStyle=s,d.fillRect(0,e*c,55,(1+e)*c),d.fill(),t=0;t<=f;t++){d.textAlign=o,d.textBaseline="middle";const s=u+p*t,f=this.freqType(s),w=this.unitType(s);var b=0==t?(1+e)*c+t-10:(1+e)*c-50*t+2;d.fillStyle=h,d.font=a+" "+r,d.fillText(w,40,b),d.fillStyle=n,d.font=i+" "+r,d.fillText(f,16,b)}}}resample(s){const i=this.width,a=[],r=1/s.length,n=1/i;let h;for(h=0;h<i;h++){const i=new Array(s[0].length);let e;for(e=0;e<s.length;e++){const a=e*r,l=a+r,c=h*n,f=c+n,u=l<=c||f<=a?0:Math.min(Math.max(l,c),Math.max(f,a))-Math.max(Math.min(l,c),Math.min(f,a));let t;if(0<u)for(t=0;t<s[0].length;t++)null==i[t]&&(i[t]=0),i[t]+=u/n*s[e][t]}const o=new Uint8Array(s[0].length);let t;for(t=0;t<s[0].length;t++)o[t]=i[t];a.push(o)}return a}}export{n as default};