class t{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null!=i&&i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){null!=(t=this.listeners[t])&&t.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class e extends t{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t())}}function i(u,c,d,p,m=3,s=0,v=100){if(!u)return()=>{};const g=matchMedia("(pointer: coarse)").matches;let f=()=>{};const t=t=>{if(t.button===s){t.preventDefault(),t.stopPropagation();let s=t.clientX,r=t.clientY,l=!1;const a=Date.now(),e=t=>{if(t.preventDefault(),t.stopPropagation(),!(g&&Date.now()-a<v)){var e=t.clientX,i=t.clientY,o=e-s,n=i-r;if(l||Math.abs(o)>m||Math.abs(n)>m){const t=u.getBoundingClientRect(),{left:m,top:v}=t;l||(null!=d&&d(s-m,r-v),l=!0),c(o,n,e-m,i-v),s=e,r=i}}},i=t=>{var e,i,o;l&&(e=t.clientX,t=t.clientY,{left:i,top:o}=u.getBoundingClientRect(),null!=p&&p(e-i,t-o)),f()},o=t=>{t.relatedTarget&&t.relatedTarget!==document.documentElement||i(t)},n=t=>{l&&(t.stopPropagation(),t.preventDefault())},h=t=>{l&&t.preventDefault()};document.addEventListener("pointermove",e),document.addEventListener("pointerup",i),document.addEventListener("pointerout",o),document.addEventListener("pointercancel",o),document.addEventListener("touchmove",h,{passive:!1}),document.addEventListener("click",n,{capture:!0}),f=()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",i),document.removeEventListener("pointerout",o),document.removeEventListener("pointercancel",o),document.removeEventListener("touchmove",h),setTimeout(()=>{document.removeEventListener("click",n,{capture:!0})},10)}}};return u.addEventListener("pointerdown",t),()=>{f(),u.removeEventListener("pointerdown",t)}}function o(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,n]of Object.entries(e))if("children"===t)for(const[t,s]of Object.entries(e))"string"==typeof s?i.appendChild(document.createTextNode(s)):i.appendChild(o(t,s));else"style"===t?Object.assign(i.style,n):"textContent"===t?i.textContent=n:i.setAttribute(t,n.toString());return i}function n(t,e,i){t=o(t,e||{});return null!=i&&i.appendChild(t),t}const s={points:[],lineWidth:4,lineColor:"rgba(0, 0, 255, 0.5)",dragPointSize:10,dragPointFill:"rgba(255, 255, 255, 0.8)",dragPointStroke:"rgba(255, 255, 255, 0.8)"};class r extends t{constructor(t,e){super(),this.subscriptions=[],this.subscriptions=[],this.options=t,this.polyPoints=new Map;const o=e.clientWidth,s=e.clientHeight,r=n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"100%",height:"100%",viewBox:`0 0 ${o} `+s,preserveAspectRatio:"none",style:{position:"absolute",left:"0",top:"0",zIndex:"4"},part:"envelope"},e),l=(this.svg=r,n("polyline",{xmlns:"http://www.w3.org/2000/svg",points:`0,${s} ${o},`+s,stroke:t.lineColor,"stroke-width":t.lineWidth,fill:"none",part:"polyline",style:t.dragLine?{cursor:"row-resize",pointerEvents:"stroke"}:{}},r));t.dragLine&&this.subscriptions.push(i(l,(t,i)=>{const o=r.viewBox.baseVal["height"],e=l["points"];for(let t=1;t<e.numberOfItems-1;t++){const n=e.getItem(t);n.y=Math.min(o,Math.max(0,n.y+i))}const n=r.querySelectorAll("ellipse");Array.from(n).forEach(t=>{const e=Math.min(o,Math.max(0,Number(t.getAttribute("cy"))+i));t.setAttribute("cy",e.toString())}),this.emit("line-move",i/o)})),r.addEventListener("dblclick",t=>{var e=r.getBoundingClientRect(),i=t.clientX-e.left,t=t.clientY-e.top;this.emit("point-create",i/e.width,t/e.height)});{let t;const e=()=>clearTimeout(t);r.addEventListener("touchstart",o=>{1===o.touches.length?t=window.setTimeout(()=>{o.preventDefault();var t=r.getBoundingClientRect(),e=o.touches[0].clientX-t.left,i=o.touches[0].clientY-t.top;this.emit("point-create",e/t.width,i/t.height)},500):e()}),r.addEventListener("touchmove",e),r.addEventListener("touchend",e)}}makeDraggable(t,e){this.subscriptions.push(i(t,e,()=>t.style.cursor="grabbing",()=>t.style.cursor="grab",1))}createCircle(t,e){var i=this.options.dragPointSize/2;return n("ellipse",{xmlns:"http://www.w3.org/2000/svg",cx:t,cy:e,rx:i,ry:i,fill:this.options.dragPointFill,stroke:this.options.dragPointStroke,"stroke-width":"2",style:{cursor:"grab",pointerEvents:"all"},part:"envelope-circle"},this.svg)}removePolyPoint(t){var e=this.polyPoints.get(t);if(e){const{polyPoint:i,circle:o}=e,n=this.svg.querySelector("polyline")["points"],s=Array.from(n).findIndex(t=>t.x===i.x&&t.y===i.y);n.removeItem(s),o.remove(),this.polyPoints.delete(t)}}addPolyPoint(t,e,n){const i=this["svg"],{width:s,height:r}=i.viewBox.baseVal,o=t*s,l=r-e*r,a=this.options.dragPointSize/2,h=i.createSVGPoint(),u=(h.x=t*s,h.y=r-e*r,this.createCircle(o,l)),c=i.querySelector("polyline")["points"],d=Array.from(c).findIndex(t=>t.x>=o);c.insertItemBefore(h,Math.max(d,1)),this.polyPoints.set(n,{polyPoint:h,circle:u}),this.makeDraggable(u,(t,e)=>{const i=h.x+t,o=h.y+e;i<-a||o<-a||i>s+a||o>r+a?this.emit("point-dragout",n):(t=Array.from(c).find(t=>t.x>h.x),e=Array.from(c).findLast(t=>t.x<h.x),t&&i>=t.x||e&&i<=e.x||(h.x=i,h.y=o,u.setAttribute("cx",i.toString()),u.setAttribute("cy",o.toString()),this.emit("point-move",n,i/s,o/r)))})}update(){const t=this["svg"],n=t.viewBox.baseVal.width/t.clientWidth,s=t.viewBox.baseVal.height/t.clientHeight;t.querySelectorAll("ellipse").forEach(t=>{const e=this.options.dragPointSize/2,i=e*n,o=e*s;t.setAttribute("rx",i.toString()),t.setAttribute("ry",o.toString())})}destroy(){this.subscriptions.forEach(t=>t()),this.polyPoints.clear(),this.svg.remove()}}class l extends e{constructor(t){super(t),this.polyline=null,this.throttleTimeout=null,this.volume=1,this.points=t.points||[],this.options=Object.assign({},s,t),this.options.lineColor=this.options.lineColor||s.lineColor,this.options.dragPointFill=this.options.dragPointFill||s.dragPointFill,this.options.dragPointStroke=this.options.dragPointStroke||s.dragPointStroke,this.options.dragPointSize=this.options.dragPointSize||s.dragPointSize}static create(t){return new l(t)}addPoint(e){e.id||(e.id=Math.random().toString(36).slice(2));var t=this.points.findLastIndex(t=>t.time<e.time),t=(this.points.splice(t+1,0,e),this.emitPoints(),null==(t=this.wavesurfer)?void 0:t.getDuration());t&&this.addPolyPoint(e,t)}removePoint(t){var e=this.points.indexOf(t);-1<e&&(this.points.splice(e,1),null!=(e=this.polyline)&&e.removePolyPoint(t),this.emitPoints())}getPoints(){return this.points}setPoints(t){this.points.slice().forEach(t=>this.removePoint(t)),t.forEach(t=>this.addPoint(t))}destroy(){var t;null!=(t=this.polyline)&&t.destroy(),super.destroy()}getCurrentVolume(){return this.volume}setVolume(t){var e;this.volume=t,null!=(e=this.wavesurfer)&&e.setVolume(t)}onInit(){var t;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const e=this["options"];e.volume=null!=(t=e.volume)?t:this.wavesurfer.getVolume(),this.setVolume(e.volume),this.subscriptions.push(this.wavesurfer.on("decode",e=>{this.initPolyline(),this.points.forEach(t=>{this.addPolyPoint(t,e)})}),this.wavesurfer.on("redraw",()=>{var t;null!=(t=this.polyline)&&t.update()}),this.wavesurfer.on("timeupdate",t=>{this.onTimeUpdate(t)}))}emitPoints(){this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.throttleTimeout=setTimeout(()=>{this.emit("points-change",this.points)},200)}initPolyline(){var t;this.polyline&&this.polyline.destroy(),this.wavesurfer&&(t=this.wavesurfer.getWrapper(),this.polyline=new r(this.options,t),this.subscriptions.push(this.polyline.on("point-move",(t,e,i)=>{var o=(null==(o=this.wavesurfer)?void 0:o.getDuration())||0;t.time=e*o,t.volume=1-i,this.emitPoints()}),this.polyline.on("point-dragout",t=>{this.removePoint(t)}),this.polyline.on("point-create",(t,e)=>{this.addPoint({time:t*((null==(t=this.wavesurfer)?void 0:t.getDuration())||0),volume:1-e})}),this.polyline.on("line-move",e=>{var t;this.points.forEach(t=>{t.volume=Math.min(1,Math.max(0,t.volume-e))}),this.emitPoints(),this.onTimeUpdate((null==(t=this.wavesurfer)?void 0:t.getCurrentTime())||0)})))}addPolyPoint(t,e){var i;null!=(i=this.polyline)&&i.addPolyPoint(t.time/e,t.volume,t)}onTimeUpdate(i){if(this.wavesurfer){let t=this.points.find(t=>t.time>i),e=(t=t||{time:this.wavesurfer.getDuration()||0,volume:0},this.points.findLast(t=>t.time<=i));e=e||{time:0,volume:0};var o=t.time-e.time,n=t.volume-e.volume,n=e.volume+(i-e.time)*(n/o),o=Math.min(1,Math.max(0,n)),n=Math.round(100*o)/100;n!==this.getCurrentVolume()&&(this.setVolume(n),this.emit("volume-change",n))}}}export{l as default};