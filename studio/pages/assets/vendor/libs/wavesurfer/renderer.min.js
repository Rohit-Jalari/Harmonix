var __awaiter=this&&this.__awaiter||function(t,n,a,l){return new(a=a||Promise)(function(r,e){function i(t){try{s(l.next(t))}catch(t){e(t)}}function o(t){try{s(l.throw(t))}catch(t){e(t)}}function s(t){var e;t.done?r(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(i,o)}s((l=l.apply(t,n||[])).next())})},__rest=this&&this.__rest||function(t,e){var r={};for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(r[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,o=Object.getOwnPropertySymbols(t);i<o.length;i++)e.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(t,o[i])&&(r[o[i]]=t[o[i]]);return r};import{makeDraggable}from"./draggable.js";import EventEmitter from"./event-emitter.js";class Renderer extends EventEmitter{constructor(t,e){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=t;const r=this.parentFromOptionsContainer(t.container),[i,o]=(this.parent=r,this.initHtml());r.appendChild(i),this.container=i,this.scrollContainer=o.querySelector(".scroll"),this.wrapper=o.querySelector(".wrapper"),this.canvasWrapper=o.querySelector(".canvases"),this.progressWrapper=o.querySelector(".progress"),this.cursor=o.querySelector(".cursor"),e&&o.appendChild(e),this.initEvents()}parentFromOptionsContainer(t){let e;if("string"==typeof t?e=document.querySelector(t):t instanceof HTMLElement&&(e=t),e)return e;throw new Error("Container not found")}initEvents(){const r=t=>{var e=this.wrapper.getBoundingClientRect(),r=t.clientX-e.left,t=t.clientY-e.top;return[r/e.width,t/e.height]},t=(this.wrapper.addEventListener("click",t=>{var[t,e]=r(t);this.emit("click",t,e)}),this.wrapper.addEventListener("dblclick",t=>{var[t,e]=r(t);this.emit("dblclick",t,e)}),!0!==this.options.dragToSeek&&"object"!=typeof this.options.dragToSeek||this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{var{scrollLeft:t,scrollWidth:e,clientWidth:r}=this.scrollContainer;this.emit("scroll",t/e,(t+r)/e)}),this.createDelay(100));this.resizeObserver=new ResizeObserver(()=>{t().then(()=>this.onContainerResize()).catch(()=>{})}),this.resizeObserver.observe(this.scrollContainer)}onContainerResize(){var t=this.parent.clientWidth;t===this.lastContainerWidth&&"auto"!==this.options.height||(this.lastContainerWidth=t,this.reRender())}initDrag(){this.subscriptions.push(makeDraggable(this.wrapper,(t,e,r)=>{this.emit("drag",Math.max(0,Math.min(1,r/this.wrapper.getBoundingClientRect().width)))},t=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))},t=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))}))}getHeight(t,e){var r,i=(null==(i=this.audioData)?void 0:i.numberOfChannels)||1;return null==t?128:isNaN(Number(t))?"auto"===t?(r=this.parent.clientHeight||128,null!=e&&e.every(t=>!t.overlay)?r/i:r):128:Number(t)}initHtml(){const t=document.createElement("div"),e=t.attachShadow({mode:"open"});return e.innerHTML=`
      <style>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[t,e]}setOptions(t){if(this.options.container!==t.container){const e=this.parentFromOptionsContainer(t.container);e.appendChild(this.container),this.parent=e}!0!==t.dragToSeek&&"object"!=typeof this.options.dragToSeek||this.initDrag(),this.options=t,this.reRender()}getWrapper(){return this.wrapper}getScroll(){return this.scrollContainer.scrollLeft}setScroll(t){this.scrollContainer.scrollLeft=t}setScrollPercentage(t){var e=this.scrollContainer["scrollWidth"];this.setScroll(e*t)}destroy(){var t;this.subscriptions.forEach(t=>t()),this.container.remove(),null!=(t=this.resizeObserver)&&t.disconnect()}createDelay(r=10){let i,o;const s=()=>{i&&clearTimeout(i),o&&o()};return this.timeouts.push(s),()=>new Promise((t,e)=>{s(),o=e,i=setTimeout(()=>{i=void 0,o=void 0,t()},r)})}convertColorValues(t){if(!Array.isArray(t))return t||"";if(t.length<2)return t[0]||"";const e=document.createElement("canvas"),r=e.getContext("2d");var i=e.height*(window.devicePixelRatio||1);const o=r.createLinearGradient(0,0,0,i),s=1/(t.length-1);return t.forEach((t,e)=>{e*=s;o.addColorStop(e,t)}),o}renderBarWaveform(t,e,r,i){var o=t[0],s=t[1]||t[0],n=o.length,{width:t,height:a}=r.canvas,l=a/2,h=window.devicePixelRatio||1,c=e.barWidth?e.barWidth*h:1,d=e.barGap?e.barGap*h:e.barWidth?c/2:0,p=e.barRadius||0,u=t/(c+d)/n,v=p&&"roundRect"in r?"roundRect":"rect";r.beginPath();let g=0,m=0,f=0;for(let t=0;t<=n;t++){var w=Math.round(t*u);if(w>g){var b=Math.round(m*l*i),C=b+Math.round(f*l*i)||1;let t=l-b;"top"===e.barAlign?t=0:"bottom"===e.barAlign&&(t=a-C),r[v](g*(c+d),t,c,C,p),g=w,m=0,f=0}b=Math.abs(o[t]||0),C=Math.abs(s[t]||0);b>m&&(m=b),C>f&&(f=C)}r.fill(),r.closePath()}renderLineWaveform(c,t,d,p){var e=e=>{var r=c[e]||c[0],i=r.length,t=d.canvas["height"],o=t/2,s=d.canvas.width/i;d.moveTo(0,o);let n=0,a=0;for(let t=0;t<=i;t++){var l=Math.round(t*s),h=(l>n&&(h=Math.round(a*o*p)||1,d.lineTo(n,o+h*(0===e?-1:1)),n=l,a=0),Math.abs(r[t]||0));h>a&&(a=h)}d.lineTo(n,o)};d.beginPath(),e(0),e(1),d.fill(),d.closePath()}renderWaveform(e,r,i){if(i.fillStyle=this.convertColorValues(r.waveColor),r.renderFunction)r.renderFunction(e,i);else{let t=r.barHeight||1;var o;r.normalize&&(o=Array.from(e[0]).reduce((t,e)=>Math.max(t,Math.abs(e)),0),t=o?1/o:1),r.barWidth||r.barGap||r.barAlign?this.renderBarWaveform(e,r,i,t):this.renderLineWaveform(e,r,i,t)}}renderSingleCanvas(t,e,r,i,o,s,n){var a=window.devicePixelRatio||1;const l=document.createElement("canvas");l.width=Math.round(r*a),l.height=Math.round(i*a),l.style.width=r+"px",l.style.height=i+"px",l.style.left=Math.round(o)+"px",s.appendChild(l);a=l.getContext("2d");if(this.renderWaveform(t,e,a),0<l.width&&0<l.height){const h=l.cloneNode(),c=h.getContext("2d");c.drawImage(l,0,0),c.globalCompositeOperation="source-in",c.fillStyle=this.convertColorValues(e.progressColor),c.fillRect(0,0,l.width,l.height),n.appendChild(h)}}renderMultiCanvas(n,a,l,h,c,d){return __awaiter(this,void 0,void 0,function*(){var t=window.devicePixelRatio||1;const s=l/t;let e=Math.min(Renderer.MAX_CANVAS_WIDTH,this.scrollContainer.clientWidth);(a.barWidth||a.barGap)&&(t=(t=a.barWidth||.5)+(a.barGap||t/2),e%t!=0&&(e=Math.floor(e/t)*t));const r=t=>{const i=t*e,o=Math.min(s-i,e);t=n.map(t=>{var e=Math.floor(i/s*t.length),r=Math.floor((i+o)/s*t.length);return t.slice(e,r)});this.renderSingleCanvas(t,a,o,h,i,c,d)},i=Math.ceil(s/e);if(1===i)r(0);else{t=this.scrollContainer.scrollLeft/s;const o=Math.floor(t*i);r(o),r(o+1),yield Promise.all([__awaiter(this,void 0,void 0,function*(){const e=this.createDelay();for(let t=o-1;0<=t;t--)yield e(),r(t)}),__awaiter(this,void 0,void 0,function*(){const e=this.createDelay();for(let t=o+2;t<i;t++)yield e(),r(t)})])}})}renderChannel(o,s,n,a){return __awaiter(this,void 0,void 0,function*(){var t=s["overlay"],e=__rest(s,["overlay"]);const r=document.createElement("div");var i=this.getHeight(e.height,e.splitChannels),t=(r.style.height=i+"px",t&&0<a&&(r.style.marginTop=`-${i}px`),this.canvasWrapper.style.minHeight=i+"px",this.canvasWrapper.appendChild(r),r.cloneNode());this.progressWrapper.appendChild(t),yield this.renderMultiCanvas(o,e,n,i,r,t)})}render(n){return __awaiter(this,void 0,void 0,function*(){this.timeouts.forEach(t=>t()),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",null!=this.options.width&&(this.scrollContainer.style.width="number"==typeof this.options.width?this.options.width+"px":this.options.width);var t=window.devicePixelRatio||1,e=this.scrollContainer.clientWidth,r=Math.ceil(n.duration*(this.options.minPxPerSec||0)),i=(this.isScrollable=e<r,this.options.fillParent&&!this.isScrollable);const o=(i?e:r)*t;this.wrapper.style.width=i?"100%":r+"px",this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=""+(this.options.cursorColor||this.options.progressColor),this.cursor.style.width=this.options.cursorWidth+"px",this.audioData=n,this.emit("render");try{if(this.options.splitChannels)yield Promise.all(Array.from({length:n.numberOfChannels}).map((t,e)=>{var r=Object.assign(Object.assign({},this.options),null==(r=this.options.splitChannels)?void 0:r[e]);return this.renderChannel([n.getChannelData(e)],r,o,e)}));else{const s=[n.getChannelData(0)];1<n.numberOfChannels&&s.push(n.getChannelData(1)),yield this.renderChannel(s,this.options,o,0)}}catch(t){return}this.emit("rendered")})}reRender(){if(this.audioData){var e=this.scrollContainer["scrollWidth"],r=this.progressWrapper.getBoundingClientRect()["right"];if(this.render(this.audioData),this.isScrollable&&e!==this.scrollContainer.scrollWidth){e=this.progressWrapper.getBoundingClientRect()["right"];let t=e-r;t=(t*=2)<0?Math.floor(t):Math.ceil(t),t/=2,this.scrollContainer.scrollLeft+=t}}}zoom(t){this.options.minPxPerSec=t,this.reRender()}scrollIntoView(t,e=!1){var{scrollLeft:r,scrollWidth:i,clientWidth:o}=this.scrollContainer,t=t*i,s=r,n=r+o,a=o/2,n=(this.isDragging?n<30+t?this.scrollContainer.scrollLeft+=30:t-30<s&&(this.scrollContainer.scrollLeft-=30):((t<s||n<t)&&(this.scrollContainer.scrollLeft=t-(this.options.autoCenter?a:0)),s=t-r-a,e&&this.options.autoCenter&&0<s&&(this.scrollContainer.scrollLeft+=Math.min(s,10))),this.scrollContainer.scrollLeft);this.emit("scroll",n/i,(n+o)/i)}renderProgress(t,e){var r;isNaN(t)||(this.canvasWrapper.style.clipPath=`polygon(${r=100*t}% 0, 100% 0, 100% 100%, ${r}% 100%)`,this.progressWrapper.style.width=r+"%",this.cursor.style.left=r+"%",this.cursor.style.transform=`translateX(-${100===Math.round(r)?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(t,e))}exportImage(i,o,r){return __awaiter(this,void 0,void 0,function*(){var t,e=this.canvasWrapper.querySelectorAll("canvas");if(e.length)return"dataURL"===r?(t=Array.from(e).map(t=>t.toDataURL(i,o)),Promise.resolve(t)):Promise.all(Array.from(e).map(t=>new Promise((e,r)=>{t.toBlob(t=>{t?e(t):r(new Error("Could not export image"))},i,o)})));throw new Error("No waveform data")})}}Renderer.MAX_CANVAS_WIDTH=4e3;export default Renderer;